<?php

use CristianDev\LaravelServerMonitor\Console\Commands\Security\SecurityCheckMalwareCommand;
use CristianDev\LaravelServerMonitor\Services\Security\SecurityScannerService;
use CristianDev\LaravelServerMonitor\Traits\NotifiesSecurityAlerts;
use Illuminate\Support\Facades\Notification;

describe('SecurityCheckMalwareCommand', function () {
    beforeEach(function () {
        Notification::fake();

        // Always mock the SecurityScannerService to prevent slow system calls
        $mockScanner = Mockery::mock(SecurityScannerService::class);
        $mockScanner->shouldReceive('checkSuspiciousProcesses')->andReturn(null)->byDefault();
        $mockScanner->shouldReceive('checkSuspiciousPorts')->andReturn([])->byDefault();
        $mockScanner->shouldReceive('checkMalwarePatterns')->andReturn([])->byDefault();

        app()->instance(SecurityScannerService::class, $mockScanner);
    });

    it('runs successfully', function () {
        $this->artisan('security:check-malware')
            ->assertExitCode(0);
    });

    it('uses the NotifiesSecurityAlerts trait', function () {
        $command = new SecurityCheckMalwareCommand();

        expect(class_uses($command))->toContain(NotifiesSecurityAlerts::class);
    });

    it('uses SecurityScannerService for malware checks', function () {
        // The service is already mocked in beforeEach, just run the command
        $this->artisan('security:check-malware')
            ->assertExitCode(0);
    });

    it('command class exists and is properly configured', function () {
        expect(class_exists(SecurityCheckMalwareCommand::class))->toBeTrue();

        $command = new SecurityCheckMalwareCommand();
        expect($command->getName())->toBe('security:check-malware');
    });

    it('handles malware patterns detection', function () {
        // Override the default mock to return some alerts
        $mockScanner = Mockery::mock(SecurityScannerService::class);
        $mockScanner->shouldReceive('checkMalwarePatterns')->andReturn([
            [
                'type' => 'Suspicious PHP Code Patterns',
                'details' => 'Found suspicious patterns',
            ],
        ]);

        app()->instance(SecurityScannerService::class, $mockScanner);

        $this->artisan('security:check-malware')
            ->expectsOutput('Starting malware pattern scan...')
            ->expectsOutput('Suspicious patterns detected in 1 location(s)!')
            ->assertExitCode(1); // Should return 1 when malware is found
    });

    it('handles system commands gracefully', function () {
        // The service is already mocked in beforeEach to return safe responses
        $this->artisan('security:check-malware')
            ->assertExitCode(0);
    });
});