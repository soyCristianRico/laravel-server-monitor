<?php

namespace CristianDev\LaravelServerMonitor\Console\Commands\Security;

use CristianDev\LaravelServerMonitor\Services\Security\SecurityScannerService;
use CristianDev\LaravelServerMonitor\Traits\NotifiesSecurityAlerts;
use Illuminate\Console\Command;

class SecurityCheckMalwareCommand extends Command
{
    use NotifiesSecurityAlerts;

    protected $signature = 'security:check-malware';

    protected $description = 'Scan for malware patterns in PHP files';

    public function handle(): int
    {
        $this->initializeNotificationService();
        $scanner = app(SecurityScannerService::class);

        $this->info('Starting malware pattern scan...');

        $alerts = $scanner->checkMalwarePatterns();

        if (! empty($alerts)) {
            $this->error('Suspicious patterns detected in ' . count($alerts) . ' location(s)!');

            foreach ($alerts as $alert) {
                $this->error("Type: {$alert['type']}");
                $this->line($alert['details']);
                $this->line('---');
            }

            $this->sendSecurityAlerts($alerts,
                'Malware patterns detected! Security team notified.',
                'Malware patterns detected but no admin users found to notify.'
            );

            return 1;
        }

        $this->info('âœ… No suspicious patterns detected');

        return 0;
    }
}